<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/my/profile.css">
    <link rel="stylesheet" href="/css/fragment/mypage_navbar.css">
    <link rel="stylesheet" href="/css/fragment/footer.css">
    <script defer src="/js/fragment/mypage_navbar.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<html>

<body>
    <header th:replace="/fragment/header::header"></header>
    <div class="container my lg" style="margin-top: 100px">
        <div>
            <!-- navbar -->
            <nav th:replace="/fragment/mypage_navbar"></nav>
        </div>
        <div class="content_area">
            <div class="my_profile">
                <div class="content_title border">
                    <div class="title">
                        <h3>프로필 정보</h3>
                        <!---->
                    </div>
                    <!---->
                </div>
                <div class="user_profile">
                    <div class="profile_thumb"><img id="profile_img" src="/img/profile.png" alt="사용자 이미지" class="thumb_img read_img"></div>
                    <div class="profile_detail"><strong class="name" id="profile_name">fd730</strong>
                        <div class="profile_btn_box"><label href="#" class="btn outlinegrey small" for="modify_img"> 이미지 변경 </label><a href="#"
                                class="btn outlinegrey small" onclick="delete_img()"> 삭제 </a></div>
                    </div>
                </div><input type="file" id="modify_img" accept="image/png, image/jpeg" hidden="hidden"><canvas width="1000"
                    height="1000" style="display: none;"></canvas>
                <div class="profile_info">
                    <div class="profile_group">
                        <h4 class="group_title">로그인 정보</h4>
                        <div class="unit unit_email">
                            <h5 class="title">이메일 주소</h5>
                            <p class="desc email" id="profile_email">f***0@naver.com</p><button type="button"
                                class="btn btn_modify outlinegrey small" onclick="pop_email()"> 변경 </button>
                        </div>

                        <div class="modify modify_email" style="display: none;">
                            <div class="input_box" id="email_input_box">
                                <h6 class="input_title">이메일 주소 변경</h6>
                                <div class="input_item" id="email_input"><input id="change_email" type="email" autocomplete="off" class="input_txt"
                                        placeholder="f***0@naver.com"></div>
                                <p class="input_error" id="email_input_error"> 이메일 주소를 정확히 입력해주세요. </p>
                            </div>
                            <div class="modify_btn_box"><button type="button" class="btn outlinegrey medium"
                                    slot="button" onclick="close_email()"> 취소 </button><button id="button_email" type="button"
                                    class="btn solid medium disabled" slot="button" onclick="emailSendIt()"> 변경 </button></div>
                        </div>
                        <div class="unit unit_password">
                            <h5 class="title">비밀번호</h5>
                            <p class="desc password" id="profile_password">•••••••••</p><button type="button"
                                class="btn btn_modify outlinegrey small" onclick="pop_password()"> 변경 </button>
                        </div>
                        <div class="modify  modify_password" style="display: none;">
                            <h5 class="title">비밀번호 변경</h5>
                            <div class="input_box">
                                <h6 class="input_title">이전 비밀번호</h6>
                                <div class="input_item"><input id="pw1" type="password" placeholder="영문, 숫자, 특수문자 조합 8-16자"
                                        autocomplete="off" class="input_txt"></div>
                                <p class="input_error"> 영문, 숫자, 특수문자를 조합해서 입력해주세요. (8-16자)
                                </p>
                            </div>
                            <div class="input_box" id="password_input_box">
                                <h6 class="input_title">새 비밀번호</h6>
                                <div class="input_item"><input id="pw2" type="password" placeholder="영문, 숫자, 특수문자 조합 8-16자"
                                        autocomplete="off" class="input_txt"></div>
                                <p class="input_error"> 영문, 숫자, 특수문자를 조합해서 입력해주세요. (8-16자)
                                </p>
                            </div>
                            <div class="modify_btn_box"><button type="button" class="btn outlinegrey medium"
                                    slot="button" onclick="close_password()"> 취소 </button><button id="button_password" type="button"
                                    class="btn solid medium disabled" slot="button" onclick="pwSendIt()"> 저장 </button></div>
                        </div>
                    </div>
                    <div class="profile_group">
                        <h4 class="group_title">개인 정보</h4>
                        <div class="unit unit_name">
                            <h5 class="title">이름</h5>
                            <p class="desc" id="profile_nickname">fd730</p><button type="button" class="btn btn_modify outlinegrey small" onclick="pop_name()"> 변경
                            </button>
                        </div>
                        <div class="modify name modify_name" style="display: none;">
                            <h5 class="title">이름</h5>
                            <div class="input_box" id="name_input_box">
                                <h6 class="input_title">새로운 이름</h6>
                                <div class="input_item"><input type="text" id="name_input" placeholder="고객님의 이름" autocomplete="off"
                                        class="input_txt"></div>
                                <p class="input_error" id="name_input_error"></p>
                            </div>
                            <div class="modify_btn_box"><button type="button" class="btn outlinegrey medium close_name "
                                    slot="button"> 취소 </button><button type="button"
                                    class="btn solid medium disabled close_name" id="name_save"slot="button" onclick="nicknameSendIt()"> 저장 </button></div>
                        </div>
                        <div class="unit unit_hp">
                            <h5 class="title">휴대폰 번호</h5>
                            <p class="desc" id="profile_hp">010-5***-*794</p><button type="button"
                                class="btn btn_modify outlinegrey small"  onclick="pop_hp()"> 변경 </button>
                        </div>
                        <div class="modify modify_hp" style="display: none;">
                            <h5 class="title">휴대폰 번호</h5>
                            <div class="input_box" id="hp_input_box">
                                <h6 class="input_title">새로운 휴대폰 번호</h6>
                                <div class="input_item"><input type="text" id="hp_input" placeholder="- 없이 입력" autocomplete="off"
                                                               class="input_txt" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');"></div>
                                <p class="input_error" id="hp_input_error">정확한 휴대폰 번호를 입력해주세요</p>
                            </div>
                            <div class="modify_btn_box"><button type="button" class="btn outlinegrey medium close_name "
                                                                slot="button" onclick="close_hp()"> 취소 </button><button type="button"
                                                                                                   class="btn solid medium disabled close_name" id="hp_save"slot="button" onclick="hpSendIt()"> 저장 </button></div>
                        </div>
                        <div class="unit">
                            <h5 class="title">신발 사이즈</h5>
                            <p class="desc size" id="profile_shoe">260</p><button type="button" class="btn btn_modify outlinegrey small" id ="name_size" onclick="pop_layer();"> 변경
                            </button>
                        </div>
                        <div class="layer lg layer_size" style="display: none;">
                            <div class="layer_container"><a class="btn_layer_close" ></a>
                                <div class="layer_header">
                                    <h2 class="title">사이즈 선택</h2>
                                </div>
                                <div class="layer_content">
                                    <div class="size_list_area">
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">220</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">225</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">230</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">235</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">240</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">245</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">250</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">255</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium on shoe_size"><span
                                                    class="info_txt">260</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">265</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">270</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">275</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">280</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">285</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">290</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">295</span></a></div>
                                        <div class="size_item"><a class="btn outlinegrey medium shoe_size"><span
                                                    class="info_txt">300</span></a></div>
                                    </div>
                                    <div class="layer_btn"><a class="btn solid medium" onclick="shoeSendIt()"> 확인 </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="/my/withdrawal" class="btn_withdrawal">회원 탈퇴</a>
                </div>
            </div>
        </div>
    </div>
<footer th:replace="/fragment/footer::footer"></footer>
</body>
<script>
function validateName(strName){
    // const reg_name =  /^[가-힣a-zA-Z]+$/;
    const reg_name = /^[가-힣]{2,50}$/;
    if(!reg_name.test(''+strName)){
        return false;
    }
    return true;
}
let strName=document.querySelector(".unit_name .desc").innerHTML;
document.querySelector('#name_input').addEventListener('input', e=>{
    strName=e.target.value;
    let errorMsg='';
    if(!validateName(strName)){
        errorMsg='올바른 이름을 입력해주세요. (2-50자)';
        document.querySelector('#name_input_box').className='has_button input_box has_error';
        document.querySelector('#name_input').setAttribute('validateresult',false);
        document.querySelector('#name_save').classList.add('disabled');
        document.querySelector('#name_save').disabled = true;

    } else {
        document.querySelector('#name_input_box').className='has_button input_box fill';
        document.querySelector('#name_input').setAttribute('validateresult',true);
        document.querySelector('#name_save').classList.remove('disabled');
        document.querySelector('#name_save').disabled = false;
    }
    document.querySelector('#name_input_error').innerHTML=errorMsg;
});
function pop_email(){
    document.querySelector('.unit_email').style.display="none"
    document.querySelector('.modify_email').style.display="block"
}
function close_email(){
    document.querySelector('.unit_email').style.display="block"
    document.querySelector('.modify_email').style.display="none"
}
function pop_password(){
    document.querySelector('.unit_password').style.display="none"
    document.querySelector('.modify_password').style.display="block"
}
function close_password(){
    document.querySelector('.unit_password').style.display="block"
    document.querySelector('.modify_password').style.display="none"
}
function pop_name(){
    document.querySelector('.unit_name').style.display="none"
    document.querySelector('.modify_name').style.display="block"
}
function pop_hp(){
    document.querySelector('.unit_hp').style.display="none"
    document.querySelector('.modify_hp').style.display="block"
}
function close_hp(){
    document.querySelector('.unit_hp').style.display="block"
    document.querySelector('.modify_hp').style.display="none"
}

const closename =document.querySelectorAll('.close_name')
const layer1 = document.querySelector('.modify_name')
const layer2 = document.querySelector('.unit_name')
closename.forEach((target) => {
            target.addEventListener('click', () => {

                layer1.style.display="none"
                layer2.style.display="block"
                if(validateName(strName)){
                let name=document.querySelector(".unit_name .desc")
                let name1=document.querySelector(".profile_detail .name")
                name.innerHTML=strName
                name1.innerHTML=strName
                }

            })
        })

function close_layer(){
    document.querySelector('.layer_size').style.display="none"
    let size=document.querySelector(".size.desc");
    size.innerHTML= document.querySelector(".size_item .btn.on span").innerHTML
}
function pop_layer(){
    document.querySelector('.layer_size').style.display="block"


}
let shoe2
const boxes = document.querySelectorAll(".size_item .btn");
    boxes.forEach((box) => {
        box.addEventListener("click", () => {
            boxes.forEach((e)=>{
                e.classList.remove("on")
            })
            box.classList.add("on")
            shoe2 = box.innerText
        })
    });


    function delete_img(){
    const pi = document.getElementById('profile_img');
    console.log(pi.src);
    pi.setAttribute('src', '/img/profile.png');
    console.log(pi.src);
}


// 프로필 이미지 변경
function readImage(input) {

    // console.log(input);
    if (input.files && input.files[0]) {

        const reader = new FileReader();

        reader.onload = e => {
            const newImg = document.getElementById('profile_img');
            newImg.src = '/img/profileImg/' + input.files[0].name;
        }
        reader.readAsDataURL(input.files[0]);
    }
}
$("input[type='file']").on("change", function(e){
    let formData = new FormData();
    let fileInput = $('input[type=file]');
    console.log(fileInput)
    let fileList = fileInput[0].files;
    let fileObj = fileList[0];
    console.log("fileName : " + fileObj.name); // 파일 이름 확인
    console.log("fileSize : " + fileObj.size); // 파일 사이즈 확인
    formData.append("imgUpload", fileObj);

    // const previewImage = document.getElementById("previewImage");
    // previewImage.src = "/img/styleImg/" + fileObj.name;

    // ajax를 사용하여 서버로 전송
    $.ajax({
        url: "/api/my/imgUpload", // 서버로 요청을 보낼 url
        processData : false, // 서버로 전송할 데이터를 queryStirng 형태로 변환할지 여부
        contentType : false, // 서버로 전송되는 데이터의 content-type
        data : formData, // 서버로 전송할 데이터
        type : 'POST', // 서버 요청 타입(GET, POST)
        enctype:'multipart/form-data',
        dataType : 'text', // 서버로부터 반환받을 데이터 타입
        async : false,
        success : function (data){
            alert(data);
        },
        error: function(e) {
            alert("값을 가져오지 못했습니다.");
        }
    });
    readImage(e.target);
    profileImgSend()
});


function profileImgSend(){
    const img2 = document.getElementById("modify_img").value; // 게시글 사진
    console.log(img2)
    const img = img2.substring(12)
    console.log(img)

    fetch("http://localhost:8889/api/my/changeUpload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            "transaction_time":`${new Date()}`,
            "resultCode":"ok",
            "description":"정상",
            "data":{
                "imgUrl":img
            }
        }),
    })
        .then((res) => {
            alert("프로필 사진 등록 완료")
            location.href="/my/profile";
            return;
        })
        .then((data) => {
            console.log(data);
            return;
        })
        .catch((err) => {
            alert("프로필 사진 등록 실패");
            location.reload();
            return;
        })
}
// const modifyImg = document.getElementById('modify_img');
// modifyImg.addEventListener("change", e => {
//     // console.log(e.target)
//     readImage(e.target);
//     alert('이미지가 수정되었습니다')
//     // location.href='/my/profile'
// })
// 업데이트

// 이메일
function emailSendIt() {
    if (!document.querySelector('#button_email').classList.contains('disabled')) {
        let email2 = document.querySelector('#change_email').value
        sendIt(email2, "email")
    }
}

// 닉네임
    function nicknameSendIt() {
        let nickname2 = document.querySelector('#name_input').value
        sendIt(nickname2, "nickname")
    }

// 비밀번호
    function pwSendIt() {
        if (!document.querySelector('#button_password').classList.contains('disabled')) {
            let pw1 = document.querySelector('#pw1').value
            let pw2 = document.querySelector('#pw2').value
            fetch('/api/my/profile', {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    "transaction_time": `${new Date()}`,
                    "resultCode": "ok",
                    "description": "정상",
                    "data": {
                        "memberPw": pw1 + "," + pw2
                    }
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                        console.log(data)
                        if (data == true) {
                            alert('비밀번호 수정 완료')
                            location.href = '/my/profile';
                            return;
                        } else {
                            alert('비밀번호가 일치하지 않습니다');
                            return;
                        }
                    }
                )
        }
    }

// 전화번호
function hpSendIt() {
    if(!document.querySelector('#hp_save').classList.contains('disabled')){
    let hp2 = document.querySelector('#hp_input')
    sendIt(hp2.value, 'hp')
    }
}

// 신발
function shoeSendIt() {
    console.log(shoe2)
    fetch('http://localhost:8889/api/my/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            "transaction_time":`${new Date()}`,
            "resultCode":"ok",
            "description":"정상",
            "data":{
                "shoeSize" : shoe2
            }
        }),
    }).then((res)=>{
        alert('프로필수정 완료');
        location.href='/my/profile';
        return;
    })
    close_layer()
}
// 업데이트 - sendIt - 이메일/비밀번호/전화번호
function sendIt(data, type){
    console.log('2')
    let email = null;
    let nickname = null;
    let hp = null;
    switch (type){
        case 'email' : email = data; break;
        case 'nickname' : nickname = data; break;
        case 'hp' : hp = data; break;
    }
    fetch('http://localhost:8889/api/my/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            "transaction_time":`${new Date()}`,
            "resultCode":"ok",
            "description":"정상",
            "data":{
                "email": email,
                "nickname" : nickname,
                "hp" : hp
            }
        }),
    }).then((res)=>{
        alert('프로필수정 완료');
        location.href='/my/profile';
        return;
    })
}

// 정규식

// 휴대폰 번호 정규 표현식
function validateHp(strHp){
    const reg_hp = /^01(?:0|1|6|7|8|9)(?:\d{3}|\d{4})\d{4}$/;
    if(reg_hp.test(''+strHp)){
        return true;
    }
    return false;
}
// 휴대폰 번호 유효성 검사
document.querySelector('#hp_input').addEventListener('input', e=>{
    strHp=e.target.value
    let errorMsg='';
    if(!validateHp(strHp)){
        errorMsg='휴대폰 번호를 정확히 입력해주세요.';
        document.querySelector('#hp_input_box').className='input_box has_error';
        document.querySelector('#hp_input').setAttribute('validateresult',false);
        document.querySelector('#hp_input').classList.remove('input_border')
        document.querySelector('#hp_save').classList.add('disabled')
    } else {
        document.querySelector('#hp_input_box').className='input_box fill';
        document.querySelector('#hp_input').setAttribute('validateresult',true);
        document.querySelector('#hp_input').classList.add('input_border')
        document.querySelector('#hp_save').classList.remove('disabled')
    }

});
// 이메일 정규 표현식
function validateEmail(strEmail){
    const reg_email =/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/;
    if(!reg_email.test(''+strEmail)){
        return false;
    }
    return true;
}
// 이메일 유효성 검사
document.querySelector('#change_email').addEventListener('input', e=>{
        strEmail = e.target.value;
        let errorMsg='';
        if(!validateEmail(strEmail)){
            errorMsg='이메일 주소를 정확히 입력해주세요.';
            document.querySelector('#email_input_box').className='input_box has_error';
            document.querySelector('#change_email').setAttribute('validateresult', false);
            document.querySelector('#change_email').classList.remove('input_border')
            document.querySelector('#button_email').classList.add('disabled')
        } else {
            document.querySelector('#email_input_box').className='input_box fill';
            document.querySelector('#change_email').setAttribute('validateresult', true);
            document.querySelector('#change_email').classList.add('input_border')
            document.querySelector('#button_email').classList.remove('disabled')
        }

});
// 비밀번호 정규 표현식
function validatePassword(strPassword){
    const reg_password = /^.*(?=^.{8,16}$)(?=.*\d)(?=.*[a-zA-Z])(?=.*[!@#$%^&+=]).*$/;
    if(!reg_password.test(''+strPassword)){
        return false;
    }
    return true;
}
// 비밀번호 유효성 검사
document.querySelector('#pw2').addEventListener('input', e=>{
    console.log('앙')
    let strPassword=e.target.value;
    let errorMsg='';
    if(!validatePassword(strPassword)){
        errorMsg='영문, 숫자, 특수문자를 조합해서 입력해주세요. (8-16자)';
        document.querySelector('#password_input_box').className='has_button input_box has_error';
        document.querySelector('#pw2').setAttribute('validateresult',false);
        document.querySelector('#pw2').classList.remove('input_border')
        document.querySelector('#button_password').classList.add('disabled')
    } else {
        document.querySelector('#password_input_box').className='has_button input_box fill';
        document.querySelector('#pw2').setAttribute('validateresult',true);
        document.querySelector('#pw2').classList.add('input_border')
        document.querySelector('#button_password').classList.remove('disabled')
    }
    document.querySelector('#password_input_error').innerHTML=errorMsg;
});
</script>


</html>